<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROå§¬ï½œé–‹æ”¾å¼äº’å‹•ç¯€é» Demo</title>
  <meta name="description" content="æœ€å°å¯è¡Œçš„é–‹æ”¾å¼äº’å‹•ï¼šA/B/C åˆ†å²”ï¼‹1åˆ†/5åˆ†è³‡è¨Šå¯†åº¦ï¼‹ç¶±è¦/æ¨è–¦ï¼Œå«æ²‰é»˜åµæ¸¬èˆ‡éš¨æ©Ÿæ¨¡æ¿æ± ã€‚" />
  <style>
    :root{
      --bg:#0b0f1a; --panel:#101827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#ef4444; --accent2:#22d3ee; --card:#0d1320; --edge:#ff475770;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 900px at 10% 10%,#111827 0%,transparent 60%),radial-gradient(900px 800px at 90% 30%,#0b1220 0%,transparent 60%),var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,"Noto Sans TC","PingFang TC",Arial,"Microsoft JhengHei",sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:24px;display:grid;gap:16px;grid-template-columns:1.2fr .8fr}
    header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#111,#300),radial-gradient(220px 120px at 120% -10%,#f00,transparent 40%),radial-gradient(220px 120px at -20% 120%,#0ff,transparent 40%);box-shadow:0 0 30px #f003 inset, 0 0 12px #0ff3 inset}
    .stage{border:1px solid #1f2937;border-radius:16px;background:linear-gradient(180deg,#0b1220aa,#0b1220e6), url('https://images.unsplash.com/photo-1526378722484-bd91ca387e72?q=80&w=1600&auto=format&fit=crop') center/cover;min-height:540px;padding:16px;display:flex;flex-direction:column;gap:12px}
    .chat{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:4px}
    .msg{max-width:78%;padding:12px 14px;border-radius:14px;line-height:1.5}
    .bot{align-self:flex-start;background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid #1f2937}
    .you{align-self:flex-end;background:#111827;border:1px solid #1f2937}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button{cursor:pointer;border:1px solid #334155;background:#0b1220;color:var(--ink);padding:10px 12px;border-radius:12px;transition:transform .06s ease, box-shadow .2s}
    button:hover{transform:translateY(-1px);box-shadow:0 6px 18px #0006}
    .btn-accent{border-color:#4b5563;background:linear-gradient(135deg,#111827,#0b1220);}
    .side{border:1px solid #1f2937;border-radius:16px;background:linear-gradient(180deg,#0b1220e6,#0b1220);padding:16px;position:relative}
    .side h3{margin:0 0 8px 0}
    .side .line{color:var(--muted);font-size:14px;margin:8px 0}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid #374151;font-size:12px;color:#cbd5e1}
    .pill{display:inline-flex;padding:6px 10px;border:1px solid #374151;border-radius:999px;color:#a5b4fc;font-size:12px}
    .divider{height:1px;background:#1f2937;margin:8px 0}
    .cards{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    .card{border:1px dashed #334155;border-radius:12px;padding:10px;background:#0b1220}
    .floating{position:fixed;right:20px;bottom:20px;display:flex;gap:8px;flex-wrap:wrap}
    .avatar{width:72px;height:72px;border-radius:12px;background:url('https://placehold.co/520x867/ff66a3/ffffff.png?text=%E2%80%8B') center/cover;border:1px solid #334155;box-shadow:0 0 24px #ff2b6a22}
    .sys{font-size:12px;color:#e5e7eb80}
    .apiBox{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .apiBox input{min-width:360px;flex:1;padding:8px 10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr} .apiBox input{min-width:220px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div style="font-weight:700;letter-spacing:.2px">ROå§¬ï½œé–‹æ”¾å¼äº’å‹•ç¯€é» Demo</div>
          <div class="sys">Minimal Viable Open-Ended Node Â· A/B/C Â· 1åˆ†é˜/5åˆ†é˜ Â· ç¶±è¦/æ¨è–¦ Â· æ²‰é»˜åµæ¸¬(10s)</div>
        </div>
      </div>
      <!-- æ–°å¢ï¼šAPI ç«¯é»è¨­å®š -->
      <div class="apiBox">
        <label for="api" class="sys">API ç«¯é»ï¼š</label>
        <!-- é€™è£¡å¯å¡«ä½ çš„ ngrok https URLï¼›ä¹Ÿå¯ç”¨ ?api= è¦†è“‹ -->
        <input id="api" value="https://00bd7b3e7c01.ngrok-free.app/api/chat" />
        <button id="btnSave" class="btn-accent">å„²å­˜ç«¯é»</button>
        <span class="sys" id="saveHint"></span>
      </div>
      <div class="pill">v0.2 Â· HTML å–®æª” + LLM</div>
    </header>

    <!-- ä¸»èˆå° / å°è©±å€ -->
    <section class="stage" id="stage">
      <div class="chat" id="chat"></div>
      <div class="row" id="quickRow"></div>
      <div class="hint">æç¤ºï¼š10 ç§’ç„¡æ“ä½œå°‡è‡ªå‹•ä¸Ÿå‡ºé–‹æ”¾å¼äº’å‹•å•é¡Œï¼›æˆ–æŒ‰å³ä¸‹ã€Œç«‹å³æå•ã€ã€‚</div>
    </section>

    <!-- èªªæ˜å´æ¬„ï¼ˆä¿ç•™åŸæ–‡ï¼‰ -->
    <aside class="side">
      <h3>è¨­è¨ˆé–‹æ”¾å¼äº’å‹•ç¯€é»</h3>
      <div class="badge">infoSide: right Â· enterFrom: left-top Â· exitTo: left-bottom</div>
      <div class="divider"></div>
      <div class="line">è®“ ROå§¬ä¸åªæ˜¯å›ç­”ï¼Œè€Œæœƒåœ¨é©ç•¶æ™‚æ©Ÿä¸»å‹•æå•ã€‚</div>
      <div class="line">ä¾‹å¦‚ï¼šã€Œè‚‰åŒ…å€‘ï¼Œä½ æœ€æƒ³äº†è§£å“ªä¸€éƒ¨åˆ†ï¼Ÿæ•£ç†±ã€ç‡ˆæ•ˆï¼Œé‚„æ˜¯ä¸»æ¿æ¶æ§‹ï¼Ÿã€</div>
      <div class="line">é€™æ¨£æ—¢ç¬¦åˆè¨­å®šï¼Œåˆèƒ½å¼•å°å°è©±æ›´æ·±å…¥ã€‚</div>
      <div class="divider"></div>
      <div class="cards">
        <div class="card">
          <b>å•Ÿå‹•æ™‚æ©Ÿ</b>
          <ul style="margin:8px 0 0 18px">
            <li>è§£èªªå®Œä¸€æ®µå…§å®¹</li>
            <li>æ›è©±é¡Œå‰çš„éŠœæ¥</li>
            <li>å°æ–¹æ²‰é»˜ 3 å¥ / 10 ç§’æœªå›æ‡‰</li>
          </ul>
        </div>
        <div class="card">
          <b>æ¨¡æ¿æ± </b>
          <ul style="margin:8px 0 0 18px">
            <li>ä½ æœ€æƒ³äº†è§£å“ªä¸€éƒ¨åˆ†ï¼Ÿã€”Aã€•ã€ã€”Bã€•ï¼Œé‚„æ˜¯ã€”Cã€•ï¼Ÿ</li>
            <li>è¦ 1 åˆ†é˜é‡é»ç‰ˆï¼Œé‚„æ˜¯ 5 åˆ†é˜æ·±æ½›ç‰ˆï¼Ÿ</li>
            <li>æˆ‘å…ˆçµ¦ä½ ç¶±è¦é‚„æ˜¯ç›´æ¥æ¨è–¦ï¼Ÿ</li>
          </ul>
        </div>
        <div class="card">
          <b>ç¯„ä¾‹</b>
          <ul style="margin:8px 0 0 18px">
            <li>è‚‰åŒ…å€‘ï¼Œå…ˆèŠæ•£ç†±ã€ç‡ˆæ•ˆï¼Œé‚„æ˜¯ä¸»æ¿æ¶æ§‹ï¼Ÿ</li>
            <li>æƒ³å…ˆçœ‹å¿«é€Ÿæ¯”ä¸€æ¯”ï¼Œé‚„æ˜¯è½æˆ‘èªªç‚ºä»€éº¼é€™æ¬¾æ›´ç©©ï¼Ÿ</li>
          </ul>
        </div>
      </div>
    </aside>
  </div>

  <!-- æµ®å‹•å¿«æ· -->
  <div class="floating">
    <button class="btn-accent" id="btnAsk">ç«‹å³æå•</button>
    <button id="btnReset">é‡ç½®å°è©±</button>
  </div>

<script>
// ===== 0) API ç«¯é»è®€å¯«ï¼šæ”¯æ´ ?api= èˆ‡ localStorage =====
const apiInput = () => document.getElementById('api');
(function initApiField(){
  const qs = new URL(location.href).searchParams.get('api');
  const saved = localStorage.getItem('apiEndpoint');
  if (qs) {
    apiInput().value = qs;
    localStorage.setItem('apiEndpoint', qs);
  } else if (saved) {
    apiInput().value = saved;
  }
})();
document.getElementById('btnSave').onclick = () => {
  const v = apiInput().value.trim();
  if (!/^https?:\/\//i.test(v)) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ http(s) URL'); return; }
  localStorage.setItem('apiEndpoint', v);
  const hint = document.getElementById('saveHint');
  hint.textContent = 'å·²å„²å­˜ âœ“';
  setTimeout(()=> hint.textContent = '', 1500);
};

// ===== 1) ç¯€é»è³‡æ–™ï¼ˆåŸæ¨£ä¿ç•™ï¼‰ =====
const OPEN_ENDED_NODE = {
  id:'open-ended', bg:null, bgTitle:'é–‹æ”¾å¼äº’å‹•ç¯€é»',
  playerImage:'https://placehold.co/520x867/ff66a3/ffffff.png?text=%E2%80%8B',
  nameFill:'é–‹æ”¾å¼äº’å‹•',
  module:{
    title:'é–‹æ”¾å¼äº’å‹•ç¯€é»',
    sections:[
      { label:'å•Ÿå‹•æ™‚æ©Ÿ', items:['è§£èªªå®Œä¸€æ®µå…§å®¹','æ›è©±é¡Œå‰çš„éŠœæ¥','å°æ–¹æ²‰é»˜ 3 å¥ / 10 ç§’æœªå›æ‡‰'] },
      { label:'æ¨¡æ¿', items:[
        'ä½ æœ€æƒ³äº†è§£å“ªä¸€éƒ¨åˆ†ï¼Ÿã€”Aã€•ã€ã€”Bã€•ï¼Œé‚„æ˜¯ã€”Cã€•ï¼Ÿ',
        'è¦ 1 åˆ†é˜é‡é»ç‰ˆï¼Œé‚„æ˜¯ 5 åˆ†é˜æ·±æ½›ç‰ˆï¼Ÿ',
        'æˆ‘å…ˆçµ¦ä½ ç¶±è¦é‚„æ˜¯ç›´æ¥æ¨è–¦ï¼Ÿ'
      ]},
      { label:'ç¯„ä¾‹', items:[
        'è‚‰åŒ…å€‘ï¼Œå…ˆèŠæ•£ç†±ã€ç‡ˆæ•ˆï¼Œé‚„æ˜¯ä¸»æ¿æ¶æ§‹ï¼Ÿ',
        'æƒ³å…ˆçœ‹å¿«é€Ÿæ¯”ä¸€æ¯”ï¼Œé‚„æ˜¯è½æˆ‘èªªç‚ºä»€éº¼é€™æ¬¾æ›´ç©©ï¼Ÿ'
      ]}
    ]
  },
  infoSide:'right',
  infoTitle:'è¨­è¨ˆé–‹æ”¾å¼äº’å‹•ç¯€é»',
  infoLines:[
    'è®“ ROå§¬ä¸åªæ˜¯å›ç­”ï¼Œè€Œæœƒåœ¨é©ç•¶æ™‚æ©Ÿä¸»å‹•æå•ã€‚',
    'ä¾‹å¦‚ï¼šã€Œè‚‰åŒ…å€‘ï¼Œä½ æœ€æƒ³äº†è§£å“ªä¸€éƒ¨åˆ†ï¼Ÿæ•£ç†±ã€ç‡ˆæ•ˆï¼Œé‚„æ˜¯ä¸»æ¿æ¶æ§‹ï¼Ÿã€',
    'é€™æ¨£æ—¢ç¬¦åˆè¨­å®šï¼ŒåˆåŠ©æ–¼å¼•å°å°è©±å¾€æ›´æ·±å…¥çš„äº’å‹•æ–¹å‘é€²è¡Œã€‚'
  ],
  enterFrom:'left-top', exitTo:'left-bottom', bgShift:{x:-3,y:-3}
};

// ===== 2) Prompt æ± ï¼ˆèªæ°£è®Šé«”ï¼‰ =====
const PROMPT_POOL = {
  topic: [
    'è‚‰åŒ…å€‘ï¼Œä½ æœ€æƒ³äº†è§£å“ªä¸€éƒ¨åˆ†ï¼Ÿã€”æ•£ç†±ã€•ã€ã€”ç‡ˆæ•ˆã€•ï¼Œé‚„æ˜¯ã€”ä¸»æ¿æ¶æ§‹ã€•ï¼Ÿ',
    'æƒ³å¾å“ªå€‹é¢å‘åˆ‡å…¥ï¼Ÿã€”A. æ•£ç†±ã€•ã€”B. ç‡ˆæ•ˆã€•ã€”C. ä¸»æ¿ã€•',
    'æœ¬å°å§å¯ä»¥ç›´æ¥ä¸Šé‡é»ï½å…ˆæŒ‘ä¸€å€‹å§ï¼šæ•£ç†± / ç‡ˆæ•ˆ / ä¸»æ¿ ğŸ«¶'
  ],
  depth: [
    'è¦ 1 åˆ†é˜é‡é»ç‰ˆï¼Œé‚„æ˜¯ 5 åˆ†é˜æ·±æ½›ç‰ˆï¼Ÿ',
    'è¦ä¸è¦æˆ‘å…ˆä¾†å€‹é€Ÿè®€(1m) æˆ–æ˜¯é•·ç¯‡è§£æ(5m)ï¼Ÿ',
    'æ™‚é–“æ€éº¼å®‰æ’ï¼Ÿ1 åˆ†é˜å¿«ç…§ vs 5 åˆ†é˜æ·±æ½›'
  ],
  format: [
    'æˆ‘å…ˆçµ¦ä½ ç¶±è¦é‚„æ˜¯ç›´æ¥æ¨è–¦ï¼Ÿ',
    'è¦éª¨å¹¹æ¶æ§‹(ç¶±è¦) é‚„æ˜¯ç›´æ¥èªªçµè«–(æ¨è–¦)ï¼Ÿ',
    'å…ˆè—åœ–é‚„æ˜¯ç›´çƒå»ºè­°ï¼Ÿ'
  ]
};

// ===== 3) UI èˆ‡äº’å‹• =====
const chatEl = document.getElementById('chat');
const quickRow = document.getElementById('quickRow');
const btnAsk = document.getElementById('btnAsk');
const btnReset = document.getElementById('btnReset');

let silenceTimer = null;
let lastInteract = Date.now();

function now(){return new Date().toLocaleTimeString('zh-TW',{hour12:false})}
function scrollBottom(){chatEl.scrollTop = chatEl.scrollHeight}

function msgBot(text){
  const el = document.createElement('div');
  el.className = 'msg bot';
  el.innerHTML = `ğŸŸ¥ ROå§¬ <span class="sys">${now()}</span><br>${text}`;
  chatEl.appendChild(el); scrollBottom();
}
function msgYou(text){
  const el = document.createElement('div');
  el.className = 'msg you';
  el.innerHTML = `ğŸŸ¦ ä½  <span class="sys">${now()}</span><br>${text}`;
  chatEl.appendChild(el); scrollBottom();
}

function rand(arr){return arr[Math.floor(Math.random()*arr.length)]}

function renderQuick(options){
  quickRow.innerHTML = '';
  options.forEach(opt=>{
    const b = document.createElement('button');
    b.textContent = opt.label;
    b.onclick = ()=>{ handleSelect(opt.key, opt.payload) };
    quickRow.appendChild(b);
  });
}

// ===== 4) å‘¼å« LLMï¼ˆæ”¹æ‰åŸæœ¬çš„ mockï¼‰ =====
async function callLLM(prompt){
  const api = apiInput().value.trim();
  try{
    const res = await fetch(api, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ prompt })
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok){
      throw new Error(data?.error || res.status + " " + res.statusText);
    }
    const text = (data && data.text) ? data.text : JSON.stringify(data);
    return text;
  }catch(err){
    return `ï¼ˆå‘¼å«å¤±æ•—ï¼‰${String(err)}`;
  }
}

// æ ¸å¿ƒï¼šè§¸ç™¼ä¸€çµ„ã€Œé–‹æ”¾å¼äº’å‹•ã€å•é¡Œï¼ˆä¸»é¡Œ/æ·±åº¦/æ ¼å¼ï¼‰
function askOpenEnded(sequence = ['topic','depth','format']){
  lastInteract = Date.now();
  sequence.forEach((kind, idx)=>{
    setTimeout(()=>{
      const text = rand(PROMPT_POOL[kind]);
      msgBot(text);
      if(kind==='topic'){
        renderQuick([
          {label:'æ•£ç†± (A)', key:'topic', payload:'æ•£ç†±'},
          {label:'ç‡ˆæ•ˆ (B)', key:'topic', payload:'ç‡ˆæ•ˆ'},
          {label:'ä¸»æ¿ (C)', key:'topic', payload:'ä¸»æ¿'}
        ]);
      }else if(kind==='depth'){
        renderQuick([
          {label:'1 åˆ†é˜é‡é»', key:'depth', payload:'1m'},
          {label:'5 åˆ†é˜æ·±æ½›', key:'depth', payload:'5m'}
        ]);
      }else if(kind==='format'){
        renderQuick([
          {label:'ç¶±è¦', key:'format', payload:'outline'},
          {label:'ç›´æ¥æ¨è–¦', key:'format', payload:'recommend'}
        ]);
      }
    }, idx*600);
  })
}

// è¨˜éŒ„ç•¶å‰ä½¿ç”¨è€…åå¥½
const userPrefs = { topic:null, depth:null, format:null };

async function handleSelect(key, payload){
  lastInteract = Date.now();
  msgYou(`æˆ‘é¸ï¼š${payload}`);
  userPrefs[key] = payload;

  if(userPrefs.topic && userPrefs.depth && userPrefs.format){
    quickRow.innerHTML = '';
    const summary = `æ”¶åˆ°ï½ä¸»é¡Œã€Œ${userPrefs.topic}ã€ã€æ™‚é•·ã€Œ${userPrefs.depth}ã€ã€å‘ˆç¾ã€Œ${userPrefs.format}ã€ã€‚`;
    msgBot(summary);

    // ç”¢ç”Ÿé€çµ¦ LLM çš„ promptï¼ˆä½ å¯ä»¥è‡ªç”±æ”¹å¯«ï¼‰
    const prompt = `
ä½ æ˜¯ä¸€ä½å°ˆæ¥­è¬›è§£å“¡ã€‚è«‹ç”¨ ${userPrefs.depth==='1m'?'1 åˆ†é˜é‡é»':'5 åˆ†é˜æ·±æ½›'} çš„é•·åº¦ï¼Œ
ä»¥ã€Œ${userPrefs.format==='outline'?'ç¶±è¦æ¢åˆ—':'ç›´æ¥æ¨è–¦'}ã€çš„æ–¹å¼ï¼Œèªªæ˜ä¸»é¡Œã€Œ${userPrefs.topic}ã€ã€‚
å…ˆç”¨ä¸€å¥ã€Œè¶…çŸ­é–‹å ´ã€æ‰¿æ¥äº’å‹•ï¼Œå†é€²å…¥å…§å®¹ã€‚`;

    msgBot('ï¼ˆé€£ç·šä¸­â€¦ï¼‰');
    const llmText = await callLLM(prompt);
    msgBot(llmText);

    // ä¸‹ä¸€è¼ªäº’å‹•
    resetSilence();
    userPrefs.topic = userPrefs.depth = userPrefs.format = null;
    setTimeout(()=>askOpenEnded(['topic']), 1000);
  }else{
    if(!userPrefs.topic){ askOpenEnded(['topic']) }
    else if(!userPrefs.depth){ askOpenEnded(['depth']) }
    else if(!userPrefs.format){ askOpenEnded(['format']) }
  }
}

// ===== 5) æ²‰é»˜åµæ¸¬ï¼ˆ10 ç§’ï¼‰ =====
function resetSilence(){
  if(silenceTimer) clearInterval(silenceTimer);
  silenceTimer = setInterval(()=>{
    const idle = (Date.now()-lastInteract)/1000;
    if(idle>=10){
      clearInterval(silenceTimer);
      msgBot('ï¼ˆå’³ï¼‰é€™è£¡éœ€è¦æˆ‘å¸¶ä¸€ä¸‹å—ï¼Ÿ');
      askOpenEnded(['topic']);
    }
  }, 1000);
}

// ===== 6) äº‹ä»¶ç¹«çµèˆ‡åˆå§‹åŒ– =====
document.getElementById('btnAsk').onclick = ()=> askOpenEnded();
document.getElementById('btnReset').onclick = ()=>{ chatEl.innerHTML=''; quickRow.innerHTML=''; intro(); };

function intro(){
  msgBot('æ­¡è¿å›åˆ°èˆå°ï¼Œä»Šå¤©æˆ‘å€‘å…ˆç”¨ã€Œé–‹æ”¾å¼äº’å‹•ã€ç•¶æš–èº«ï½');
  msgBot('æˆ‘æœƒåœ¨æ®µè½å¾Œã€æ›è©±é¡Œå‰ï¼Œæˆ–ä½ æ²‰é»˜ 10 ç§’æ™‚ä¸»å‹•ä¸Ÿå•é¡Œã€‚');
  askOpenEnded(['topic']);
  resetSilence();
}
intro();
</script>
</body>
</html>
